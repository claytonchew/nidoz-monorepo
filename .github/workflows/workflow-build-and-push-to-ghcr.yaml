name: Build and Push to GitHub Container Registry

on:
    workflow_call:
        inputs:
            runs-on:
                type: string
                default: "ubuntu-latest"
            environment:
                required: true
                type: string
            repository:
                type: string
                required: true
            cache_repository:
                type: string
                default: ""
            context:
                type: string
                default: "."
            dockerfile:
                type: string
                default: "./Dockerfile"
            image_tag:
                type: string
                default: ""
            image_tag_prefix:
                type: string
                default: ""
            image_tag_suffix:
                type: string
                default: ""
            generate_short_sha_in_image_tag:
                type: boolean
                default: true
            target:
                type: string
                default: ""
            telegram_chat_id:
                type: string
                required: true
            build-name:
                type: string
                default: Build and Push to ECR
        secrets:
            telegram_token:
                required: true

jobs:
    build:
        name: ${{ inputs.build-name }}

        permissions:
            contents: read
            packages: write
            attestations: write
            id-token: write

        runs-on: ${{ inputs.runs-on }}

        steps:
            - name: Checkout repo
              uses: actions/checkout@v3

            - name: Log in to the Container registry
              uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - uses: benjlevesque/short-sha@v3.0
              id: short-sha
              with:
                  length: 12

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Downcase repository name
              run: |
                  echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

            - name: Build and push
              uses: docker/build-push-action@v6
              env:
                  REGISTRY: ${{ format('ghcr.io/{0}', env.REPO) }}
                  SHORT_SHA: ${{ steps.short-sha.outputs.sha }}
                  DOCKER_BUILD_SUMMARY: true
              with:
                  context: ${{ inputs.context }}
                  file: ${{ inputs.dockerfile }}
                  push: true
                  tags: ${{ env.REGISTRY }}/${{ inputs.repository }}:${{ inputs.image_tag_prefix }}${{ inputs.generate_short_sha_in_image_tag == true && format('{0}{1}', inputs.image_tag != '' && format('{0}-', inputs.image_tag) || inputs.image_tag, env.SHORT_SHA) || (inputs.image_tag != '' && inputs.image_tag || 'latest') }}${{ inputs.image_tag_suffix }}
                  cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ inputs.cache_repository != '' && inputs.cache_repository || format('{0}/cache', inputs.repository) }}
                  cache-to: type=registry,mode=max,image-manifest=true,oci-mediatypes=true,ref=${{ env.REGISTRY }}/${{ inputs.cache_repository != '' && inputs.cache_repository || format('{0}/cache', inputs.repository) }}
                  provenance: false
                  target: ${{ inputs.target != '' && inputs.target || null }}

            # - name: Send Telegram
            #   uses: appleboy/telegram-action@master
            #   if: ${{ failure() }}
            #   with:
            #     to: ${{ inputs.telegram_chat_id }}
            #     token: ${{ secrets.telegram_token }}
            #     message: |
            #       ðŸš¨ Workflow ${{ inputs.repository }}:${{ inputs.image_tag_prefix }}${{ steps.short-sha.outputs.sha }}${{ inputs.image_tag_suffix }} build failed for ${{ inputs.environment }}

            #       Repository: ${{ github.repository }}
            #       Branch: ${{ github.ref }}
            #       Commit-tag: ${{ steps.short-sha.outputs.sha }}
            #       Build-url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
